# 多用户即时通讯系统

## 1. 用户登录

### 用户端:

1. 创建socket, 连接服务端的ServerSocket, 使用socket获取ObjectOutputStream, 并发送user信息到服务端进行验证. 

2. 使用用户端socket获取ObjectInputStream, 获取从服务端返回的 "登录验证成功或失败" 标志的消息. 

3. 如果信息标志为 "登录失败", 重新登录.

4. 如果信息标志为 "登录成功"： 

   4.1 创建一条线程, 线程里放置userId和与服务端连接上的socket, 使用socket获取ObjectInputStream, 循环接收从服务端传输过来的信息.  (相当于使用一条线程放置 客户端接收服务端消息 的数据通道)

   4.2 将线程放置在一个HashMap集合中进行管理, key是userId, Value是线程.

### 服务端:

1. 创建ServerSocket, 等待用户端socket连接.

2. 当连接上后, 使用socket获取ObjectInputStream, 获取用户端发送过来的user信息并进行验证.

3. 如果验证失败, 使用socket获取ObjectOutputStream, 并发送条 "登录失败" 标志的消息给用户端.

4. 如果验证成功:

   4.1 创建一条线程, 线程里放置userId和与指定客户端连接的socket, 使用socket获取objectInputStream循环读取用户端发送过来的消息.(相当于使用一条线程放置 服务端接收客户端消息 的数据通道)

   4.2 将线程放置在一个HashMap集合中进行管理, key是用户端userId, Value是线程. 

   4.3 使用socket获取ObjectOutputStream, 并发送条 "登录成功" 标志的消息给用户端.




## 2. 拉取在线用户列表
### 用户端:

1. 使用socket获取ObjectOutputStream, 发送一条消息给客户端带有 "请求在线用户列表" 标志的消息.
2. 在 客户端接收服务端消息 的线程里面设置判断条件, 如果服务端返回带有 "请求在线用户列表" 标志的消息, 将消息内容进行处理后打印出来.

### 服务端:

1. 在 服务端接收客户端消息 的线程里面设置判断条件, 如果用户端返回带有 "请求在线用户列表" 标志的消息.
2. 从线程管理器集合里获取当前所有线程的userId, 将其拼接起来作为消息内容.
3. 使用socket获取ObjectOutputStream, 并将消息发送给用户端. (由于子线程里放置的是与指定用户端连接的socket, 所以消息会返回给发送在线用户列表请求的用户端) 




## 3. 无异常退出(用户端，服务器端)
### 用户端:

1. 使用socket获取ObjectOutputStream, 发送一条消息给客户端带有 "用户登出" 标志的消息.

2. 在 客户端接收服务端消息 的线程里面设置判断条件, 如果服务端返回带有 "登出成功" 标志的消息, 进行以下处理:

   2.1 关闭用户端 socket.

   2.2 将线程从线程管理器集合中移除.

3. 考虑服务器宕机的异常退出. 由于 用户端接收服务端消息 线程在接收消息的处于阻塞状态, 突然服务器socket断开, 会因为循环调用 ObjectInputStream.readObject() 而循环报 SocketException 异常, 所以捕获到 SocketException 就要:

   3.1 关闭用户端 socket.

   3.2 将线程从线程管理器集合中移除.

   3.3 打印服务端宕机log.

   3.4 结束线程里的循环.

### 服务端:

1. 在 服务端接收客户端消息 的线程里面设置判断条件, 如果用户端返回带有 "用户登出" 标志的消息, 进行以下处理:

   1.1 关闭服务端 socket.

   1.2 将线程从线程管理器集合中移除.

2. 考虑用户端强制退出情况. 由于 服务端接收用户端消息 线程在接收消息的处于阻塞状态, 突然用户端socket断开, 会因为循环调用 ObjectInputStream.readObject() 而循环报 SocketException 异常, 所以捕获到 SocketException 就要:

   2.1 关闭客户端 socket.

   2.2 将线程从线程管理器集合中移除.

   2.3 打印客户端异常退出log.

   2.4 结束线程里的循环.




## 4.私聊





## 5.群聊





## 6.发文件


## 7.服务器推送新闻